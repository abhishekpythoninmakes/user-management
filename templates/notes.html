{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4">
            <div class="glass-card mb-4">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-user-circle fa-2x me-2"></i>
                    <h4 class="m-0" id="userName"></h4>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                        <i class="fas fa-plus me-2"></i>Add New Note
                    </button>
                    <a href="/profile" class="btn btn-outline-light">
                        <i class="fas fa-user me-2"></i>Profile
                    </a>
                    <button class="btn btn-outline-light mt-2" id="sidebarLogoutBtn">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </button>
                </div>
            </div>

            <div class="glass-card">
                <h5 class="mb-3">Search Notes</h5>
                <div class="search-container">
                    <input type="text" class="form-control" placeholder="Search notes..." id="searchInput">
                    <button class="btn btn-primary" type="button" id="searchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>My Notes</h2>
                <div class="d-flex">
                    <button class="btn btn-outline-light me-2" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <select class="form-select" id="sortSelect" style="max-width: 200px;">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="title">By Title</option>
                    </select>
                </div>
            </div>

            <div class="row" id="notesContainer">
                <!-- Notes will be loaded here -->
            </div>

            <div class="text-center mt-4" id="loadingSpinner">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div class="text-center mt-4 d-none" id="emptyState">
                <i class="fas fa-sticky-note fa-3x mb-3"></i>
                <h5>No notes found</h5>
                <p>Create your first note by clicking the "Add New Note" button</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title">Add New Note</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addNoteForm">
                    <div class="mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-control" id="noteTitle" required>
                        <div class="validation-message" id="titleValidation"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" id="noteDescription" rows="5" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Attachment</label>
                        <input type="file" class="form-control" id="noteAttachment">
                        <div class="form-text">Supported files: images, PDF, documents, audio, video</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn">Save Note</button>
            </div>
        </div>
    </div>
</div>

<!-- View Note Modal -->
<div class="modal fade" id="viewNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title" id="viewNoteTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted" id="viewNoteDate"></small>
                    <div>
                        <button class="btn btn-sm btn-outline-light me-2" id="editNoteBtn">
                            <i class="fas fa-edit me-1"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="deleteNoteBtn">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <p id="viewNoteDescription"></p>
                </div>

                <div id="attachmentPreview" class="d-none">
                    <h6>Attachment</h6>
                    <div id="attachmentContent"></div>
                    <a href="#" class="btn btn-sm btn-outline-light mt-2" id="downloadAttachment">
                        <i class="fas fa-download me-1"></i> Download
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title">Edit Note</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editNoteForm">
                    <input type="hidden" id="editNoteId">
                    <div class="mb-3">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-control" id="editNoteTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" id="editNoteDescription" rows="5" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateNoteBtn">Update Note</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Check if user is logged in
        const accessToken = localStorage.getItem('accessToken');
        const userData = JSON.parse(localStorage.getItem('user') || '{}');

        if (!accessToken) {
            window.location.href = '/';
            return;
        }

        // Set user name
        if (userData.username) {
            $('#userName').text(userData.username);
        }

        // Load notes
        loadNotes();

        // Search functionality
        $('#searchInput').on('input', debounce(function() {
            loadNotes($(this).val());
        }, 300));

        $('#searchBtn').on('click', function() {
            loadNotes($('#searchInput').val());
        });

        // Sort functionality
        $('#sortSelect').on('change', function() {
            loadNotes($('#searchInput').val());
        });

        // Refresh button
        $('#refreshBtn').on('click', function() {
            $(this).addClass('fa-spin');
            loadNotes($('#searchInput').val(), function() {
                $('#refreshBtn').removeClass('fa-spin');
            });
        });

        // Sidebar logout button
        $('#sidebarLogoutBtn').on('click', function() {
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken');

            if (accessToken) {
                $.ajax({
                    url: '/api/auth/logout/',
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        refresh: refreshToken
                    }),
                    success: function() {
                        // Clear all stored data
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userNotes');

                        // Redirect to login page
                        window.location.href = '/';
                    },
                    error: function() {
                        // Still logout even if API call fails
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userNotes');

                        // Redirect to login page
                        window.location.href = '/';
                    }
                });
            } else {
                // Redirect to login page if no token
                window.location.href = '/';
            }
        });

        // Check note title availability
        $('#noteTitle').on('input', debounce(function() {
            const title = $(this).val();
            const validationEl = $('#titleValidation');

            if (title.length < 2) {
                validationEl.removeClass('valid invalid').text('');
                return;
            }

            // Check if note with same title exists (client-side only)
            const notes = JSON.parse(localStorage.getItem('userNotes') || '[]');
            const exists = notes.some(note => note.title.toLowerCase() === title.toLowerCase());

            if (exists) {
                validationEl.removeClass('valid').addClass('invalid').text('You already have a note with this title');
            } else {
                validationEl.removeClass('invalid').addClass('valid').text('Title available');
            }
        }, 500));

        // Add new note
        $('#saveNoteBtn').on('click', function() {
            const title = $('#noteTitle').val();
            const description = $('#noteDescription').val();
            const attachment = $('#noteAttachment')[0].files[0];

            if (!title || !description) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            if (attachment) {
                formData.append('attachment', attachment);
            }

            $.ajax({
                url: '/api/notes/',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#addNoteModal').modal('hide');
                    $('#addNoteForm')[0].reset();
                    $('#titleValidation').text('');
                    showToast('Note added successfully', 'success');
                    loadNotes(); // Reload notes
                },
                error: function(xhr) {
                    const errors = xhr.responseJSON;
                    let errorMsg = 'Failed to add note';

                    if (errors) {
                        if (errors.title) errorMsg = errors.title[0];
                        else if (errors.description) errorMsg = errors.description[0];
                        else if (typeof errors === 'object') {
                            errorMsg = Object.values(errors)[0][0];
                        }
                    }

                    showToast(errorMsg, 'error');
                }
            });
        });

        // Edit note
        $('#updateNoteBtn').on('click', function() {
            const noteId = $('#editNoteId').val();
            const title = $('#editNoteTitle').val();
            const description = $('#editNoteDescription').val();

            if (!title || !description) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            $.ajax({
                url: '/api/notes/' + noteId + '/',
                type: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    title: title,
                    description: description
                }),
                success: function(response) {
                    $('#editNoteModal').modal('hide');
                    showToast('Note updated successfully', 'success');
                    loadNotes(); // Reload notes
                },
                error: function(xhr) {
                    const errors = xhr.responseJSON;
                    let errorMsg = 'Failed to update note';

                    if (errors) {
                        if (errors.title) errorMsg = errors.title[0];
                        else if (errors.description) errorMsg = errors.description[0];
                        else if (typeof errors === 'object') {
                            errorMsg = Object.values(errors)[0][0];
                        }
                    }

                    showToast(errorMsg, 'error');
                }
            });
        });

        // Set up view note modal events
        $('#editNoteBtn').on('click', function() {
            const noteId = $('#viewNoteModal').data('noteId');
            $('#viewNoteModal').modal('hide');
            editNote(noteId);
        });

        $('#deleteNoteBtn').on('click', function() {
            const noteId = $('#viewNoteModal').data('noteId');
            $('#viewNoteModal').modal('hide');
            deleteNote(noteId);
        });

        function loadNotes(search = '', callback = null) {
            $('#loadingSpinner').removeClass('d-none');
            $('#emptyState').addClass('d-none');

            $.ajax({
                url: '/api/notes/' + (search ? '?search=' + encodeURIComponent(search) : ''),
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function(response) {
                    $('#loadingSpinner').addClass('d-none');

                    // Store notes in localStorage for client-side validation
                    localStorage.setItem('userNotes', JSON.stringify(response));

                    // Sort notes
                    const sortBy = $('#sortSelect').val();
                    if (sortBy === 'oldest') {
                        response.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    } else if (sortBy === 'title') {
                        response.sort((a, b) => a.title.localeCompare(b.title));
                    } else {
                        response.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    }

                    renderNotes(response);
                    if (callback) callback();
                },
                error: function(xhr) {
                    $('#loadingSpinner').addClass('d-none');
                    if (xhr.status === 401) {
                        // Token expired, redirect to login
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userNotes');
                        window.location.href = '/';
                    } else {
                        showToast('Failed to load notes', 'error');
                    }
                    if (callback) callback();
                }
            });
        }

        function renderNotes(notes) {
            const container = $('#notesContainer');
            container.empty();

            if (notes.length === 0) {
                $('#emptyState').removeClass('d-none');
                return;
            }

            notes.forEach(note => {
                const createdDate = new Date(note.created_at);
                const formattedDate = createdDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const noteCard = $(`
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="glass-card note-card h-100" data-id="${note.id}">
                            <h5 class="note-title">${escapeHtml(note.title)}</h5>
                            <p class="note-description">${escapeHtml(note.description.substring(0, 120))}${note.description.length > 120 ? '...' : ''}</p>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small>${formattedDate}</small>
                                ${note.attachment ? '<i class="fas fa-paperclip"></i>' : ''}
                            </div>
                        </div>
                    </div>
                `);

                container.append(noteCard);
            });

            // Add event listeners for note cards
            $('.note-card').on('click', function() {
                const noteId = $(this).data('id');
                viewNote(noteId);
            });
        }

        function viewNote(noteId) {
            $.ajax({
                url: '/api/notes/' + noteId + '/',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function(response) {
                    // Format dates
                    const createdDate = new Date(response.created_at);
                    const modifiedDate = new Date(response.modified_at);

                    const formattedCreated = createdDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const formattedModified = modifiedDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Set modal content
                    $('#viewNoteTitle').text(response.title);
                    $('#viewNoteDescription').text(response.description);
                    $('#viewNoteDate').html(`
                        Created: ${formattedCreated}<br>
                        Modified: ${formattedModified}
                    `);

                    // Handle attachment
                    const attachmentPreview = $('#attachmentPreview');
                    const attachmentContent = $('#attachmentContent');
                    const downloadAttachment = $('#downloadAttachment');

                    if (response.attachment) {
                        const attachmentUrl = response.attachment;
                        const fileExtension = attachmentUrl.split('.').pop().toLowerCase();

                        attachmentPreview.removeClass('d-none');
                        downloadAttachment.attr('href', attachmentUrl);

                        // Show appropriate preview based on file type
                        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                            attachmentContent.html(`
                                <div class="attachment-preview">
                                    <img src="${attachmentUrl}" alt="Attachment" class="img-fluid">
                                </div>
                            `);
                        } else if (fileExtension === 'pdf') {
                            attachmentContent.html(`
                                <div class="text-center">
                                    <i class="fas fa-file-pdf attachment-icon"></i>
                                    <p>PDF Document</p>
                                </div>
                            `);
                        } else if (['mp3', 'wav', 'ogg'].includes(fileExtension)) {
                            attachmentContent.html(`
                                <div class="text-center">
                                    <i class="fas fa-file-audio attachment-icon"></i>
                                    <p>Audio File</p>
                                    <audio controls class="w-100">
                                        <source src="${attachmentUrl}" type="audio/${fileExtension}">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                            `);
                        } else if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
                            attachmentContent.html(`
                                <div class="text-center">
                                    <i class="fas fa-file-video attachment-icon"></i>
                                    <p>Video File</p>
                                    <video controls class="w-100">
                                        <source src="${attachmentUrl}" type="video/${fileExtension}">
                                        Your browser does not support the video element.
                                    </video>
                                </div>
                            `);
                        } else {
                            attachmentContent.html(`
                                <div class="text-center">
                                    <i class="fas fa-file attachment-icon"></i>
                                    <p>Document File</p>
                                </div>
                            `);
                        }
                    } else {
                        attachmentPreview.addClass('d-none');
                    }

                    // Store note ID for edit/delete operations
                    $('#viewNoteModal').data('noteId', noteId);

                    // Show modal
                    $('#viewNoteModal').modal('show');
                },
                error: function() {
                    showToast('Failed to load note details', 'error');
                }
            });
        }

        function editNote(noteId) {
            $.ajax({
                url: '/api/notes/' + noteId + '/',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function(response) {
                    $('#editNoteId').val(response.id);
                    $('#editNoteTitle').val(response.title);
                    $('#editNoteDescription').val(response.description);
                    $('#editNoteModal').modal('show');
                },
                error: function() {
                    showToast('Failed to load note details', 'error');
                }
            });
        }

        function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) return;

            $.ajax({
                url: '/api/notes/' + noteId + '/',
                type: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                success: function() {
                    showToast('Note deleted successfully', 'success');
                    loadNotes(); // Reload notes
                },
                error: function() {
                    showToast('Failed to delete note', 'error');
                }
            });
        }
    });
</script>
{% endblock %}